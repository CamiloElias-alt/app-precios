document.addEventListener("DOMContentLoaded",()=>{let t=firebase.auth(),e=firebase.firestore(),r=document.getElementById("product-list"),o=document.getElementById("logout-button"),a=document.getElementById("save-product-button"),d=document.getElementById("product-form"),n=document.getElementById("product-name"),i=document.getElementById("product-price"),c=document.getElementById("product-profit"),l=document.getElementById("welcome-message"),u=document.getElementById("search-input"),s,p,m=[];function g(){s.orderBy("name").onSnapshot(t=>{m=[],t.forEach(t=>{m.push({id:t.id,...t.data()})}),E(m,u.value.trim())},t=>{console.error("Error fetching products: ",t),alert("Error al cargar los productos.")})}function E(t,e){r.innerHTML="";let o=e.toLowerCase(),a=t.filter(t=>t.name.toLowerCase().includes(o));if(0===a.length){r.innerHTML=`<tr class="text-center"><td colspan="3" class="text-center">No se encontraron productos con el nombre "${e}".</td></tr>`;return}a.forEach(t=>{let e=t.price+t.price*t.profit/100,o=document.createElement("tr");o.innerHTML=`
                    <td data-label="Producto">${t.name}</td>
                    <td class="text-center" data-label="Precio Venta">$${e.toFixed(2)}</td>
                    <td class="text-center" data-label="Acciones">
                        <button class="btn btn-warning btn-sm edit-button" data-id="${t.id}">Editar</button>
                        <button class="btn btn-danger btn-sm delete-button" data-id="${t.id}">Eliminar</button>
                    </td>
                `,r.appendChild(o)})}t.onAuthStateChanged(t=>{t?(p=t,t.displayName?l.textContent=`\xa1Bienvenido, ${t.displayName}!`:l.textContent=`\xa1Bienvenido!`,s=e.collection("usuarios").doc(t.uid).collection("productos"),g()):window.location.href="index.html"}),u.addEventListener("input",()=>{E(m,u.value.trim())}),a.addEventListener("click",()=>{let t=n.value.trim(),e=parseFloat(i.value),r=parseFloat(c.value),o=a.getAttribute("data-edit-id");t&&!isNaN(e)&&e>0&&!isNaN(r)&&r>=0?o?s.doc(o).update({name:t,price:e,profit:r}).then(()=>{d.reset(),a.removeAttribute("data-edit-id"),$("#productModal").modal("hide")}).catch(t=>{console.error("Error updating product: ",t),alert("Error al actualizar el producto.")}):s.add({name:t,price:e,profit:r}).then(()=>{d.reset(),$("#productModal").modal("hide")}).catch(t=>{console.error("Error adding product: ",t),alert("Error al guardar el producto.")}):alert("Por favor, completa todos los campos correctamente.")}),r.addEventListener("click",t=>{if(t.target.classList.contains("delete-button")){let e=t.target.getAttribute("data-id");confirm("\xbfEst\xe1s seguro de que quieres eliminar este producto?")&&s.doc(e).delete().catch(t=>{console.error("Error deleting product: ",t),alert("Error al eliminar el producto.")})}if(t.target.classList.contains("edit-button")){let r=t.target.getAttribute("data-id");s.doc(r).get().then(t=>{if(t.exists){let e=t.data();n.value=e.name,i.value=e.price,c.value=e.profit,a.setAttribute("data-edit-id",r),$("#productModal").modal("show")}}).catch(t=>{console.error("Error al obtener el producto: ",t),alert("No se pudo cargar el producto para editar.")})}}),o.addEventListener("click",()=>{t.signOut().catch(t=>{console.error("Logout error:",t),alert("Error al cerrar sesi\xf3n.")})})});